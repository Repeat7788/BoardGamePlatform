<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>揪團 LINE 帳號綁定</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'line-green': '#06C755',
                        'line-dark': '#00973F',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f0f4f8;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <!-- LIFF SDK 引入，去除 async 改用 defer 保證 DOM 載入前JS不執行 -->
    <script src="https://static.line-scdn.net/liff/sdk/2.23.1/liff.js" defer onload="initLiffApp()"></script>
</head>
<body class="font-sans">

    <div id="app" class="w-full max-w-sm bg-white p-6 sm:p-8 rounded-xl shadow-2xl text-center transition duration-300">
        <h1 class="text-3xl font-bold mb-6 text-gray-800" style="animation: fadeIn 0.5s ease-out;">揪團 LINE 帳號綁定</h1>
        <div id="status-display">
            <div class="text-lg text-gray-500 flex items-center justify-center space-x-2">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-line-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>正在驗證身份與進行綁定...</span>
            </div>
        </div>

        <p id="error-message" class="text-red-600 font-medium mt-4 hidden"></p>
        <p id="user-info" class="text-xs text-gray-400 mt-4 break-all hidden"></p>
    </div>

    <script>
        const LIFF_ID = '2008438447-9Nv7VA8a';
        const WEBHOOK_URL = 'https://repeat-taxi.app.n8n.cloud/webhook/group-register';

        function updateStatus(isSuccess, message, details = '') {
            const statusDiv = document.getElementById('status-display');
            const errorElement = document.getElementById('error-message');
            const userInfoElement = document.getElementById('user-info');

            if (!statusDiv || !errorElement || !userInfoElement) {
                console.warn('DOM elements not fully ready for status update.');
                return;
            }

            statusDiv.innerHTML = '';

            if (isSuccess) {
                statusDiv.innerHTML = `
                    <div class="space-y-6">
                        <svg class="w-16 h-16 mx-auto text-line-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-2xl font-bold text-line-dark tracking-wide animate__animated animate__fadeIn">綁定成功！</p>
                        <div class="bg-line-green/10 p-4 rounded-lg border-l-4 border-line-green text-gray-700 text-left">
                            <p class="font-semibold mb-2">✅ 您的帳號已成功加入揪團名單。</p>
                            <p class="text-sm">請您返回 LINE 官方帳號，輸入：</p>
                            <div class="mt-2 p-2 bg-white rounded font-mono text-center font-bold text-lg text-gray-800 tracking-wider shadow-sm">
                                桌遊揪團
                            </div>
                            <p class="mt-2 text-sm text-gray-600">即可查看目前已報名人數與狀態，無需再次綁定。</p>
                        </div>
                    </div>
                `;
                errorElement.classList.add('hidden');
                userInfoElement.classList.add('hidden');
            } else {
                statusDiv.innerHTML = `
                    <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-xl font-bold text-red-600 mt-3">綁定失敗！</p>
                `;
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
                userInfoElement.textContent = details;
                userInfoElement.classList.remove('hidden');
            }
        }

        async function runBinding() {
            if (typeof liff === 'undefined') {
                updateStatus(false,
                    'LIFF SDK 載入失敗！請檢查網路或 LIFF 程式碼引入。',
                    '錯誤: liff 變數未定義。請檢查網路連線或 LINE Developers 後台 Endpoint URL 是否與實際網址不符。');
                return;
            }
            try {
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const userPayload = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    idToken: liff.getIDToken(),
                    source: 'LIFF_Bind',
                };

                const fetchResponse = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userPayload)
                });

                if (fetchResponse.ok) {
                    updateStatus(true, '綁定成功！');
                    setTimeout(() => liff.closeWindow(), 2000);
                } else {
                    const errorText = await fetchResponse.text();
                    updateStatus(false,
                        'Webhook 傳輸失敗，請稍後再試或聯絡客服。',
                        `n8n Status: ${fetchResponse.status}. 錯誤訊息: ${errorText.substring(0, 100)}...`);
                }

            } catch (error) {
                let displayMessage = 'LIFF 啟動或登入錯誤，請檢查 LIFF ID 或網路連線。';
                let detailMessage = `詳細錯誤: ${error.message}`;
                if (error.message && error.message.includes('LIFF ID')) {
                    displayMessage = 'LIFF ID 錯誤或 LIFF 權限未開啟！';
                    detailMessage = `請檢查 LIFF ID: ${LIFF_ID} 是否與 LINE Developers 後台完全一致。`;
                }
                console.error("LIFF/Binding Error:", error);
                updateStatus(false, displayMessage, detailMessage);
            }
        }

        function initLiffApp() {
            // 確保 liff.js 完成載入後執行 runBinding
            runBinding();
        }
    </script>
</body>
</html>
