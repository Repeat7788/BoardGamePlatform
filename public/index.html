<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººé¡åœ–æ¡ŒéŠã€Œæœªä¾†å°èˆªã€æªåœ˜ç¥å™¨</title>
    
    <!-- ğŸŒŸ é—œéµä¿®æ­£ï¼šåŠ å…¥ Tailwind CSS CDN è…³æœ¬ ğŸŒŸ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ä¸­æ–‡å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- è‡ªè¨‚ CSS æ¨£å¼ (ä¿ç•™æ‚¨åŸæœ‰çš„ç¾å­¸è¨­è¨ˆ) -->
    <style>
        body { 
            background: linear-gradient(135deg, #0f4392 0%, #6393d1 100%);
            margin: 0; padding: 0;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; 
        }
        .container { 
            max-width:900px; width:100%; margin:2rem auto;
            background:#fff; border-radius:20px; box-shadow:0 20px 60px #0004; overflow:hidden;
        }
        /* ä»¥ä¸‹æ˜¯æ‚¨æä¾›çš„å…¶ä»–è‡ªè¨‚æ¨£å¼ï¼Œå·²å…¨éƒ¨ä¿ç•™ */
        .header { background: linear-gradient(135deg,#0f4392 0%,#6393d1 100%);
            color:#fff;padding:2.5rem 2rem;}
        .header-content{ display:flex; align-items:center; justify-content:center; gap:2.5rem; margin-bottom:1.5rem;}
        .logo-image { width:120px; height:120px; object-fit:cover; border-radius:14px; box-shadow:0 2px 8px #0f43924d; }
        .title-section h1 { margin:0;font-size:2rem;font-weight:700;text-align:left;}
        .description { margin:0 0 1rem 0; font-size:1rem; opacity:.95; max-width:600px; margin-left:auto; margin-right:auto;
            line-height:1.6; background:rgba(255,255,255,0.1); padding:1rem 1.5rem; border-radius:12px;}
        .subtitle { margin:0; font-size:.98rem; opacity:.88; font-style:italic; text-align: center;}
        .updatetime{margin-top:1.2em;font-size:.98em;color:#fff;opacity:.94;font-weight:600; text-align: center;}
        .content {padding:2rem;}
        .process-section{background:#fff;border-radius:16px;padding:2rem;margin-bottom:2rem;border:2px solid #eeba2b;box-shadow:0 4px 20px #eeba2b26;}
        .process-title{color:#112947;font-size:1.5rem;font-weight:700;text-align:center;margin:0 0 1.5rem 0;}
        .process-steps{display:flex;justify-content:space-between;align-items:stretch;gap:1rem;}
        .step{flex:1;display:flex;flex-direction:column;align-items:center;text-align:center;background:#f8e185;padding:1.5rem 1rem;border-radius:12px;border:1px solid #eeba2b;}
        .step-number{background:#0f4392;color:#fff;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;margin-bottom:1rem;}
        .step-content h3{color:#112947;font-size:1.1rem;font-weight:600;margin:0 0 0.75rem 0;}
        .step-content p{color:#112947;font-size:0.9rem;line-height:1.4;margin:0;opacity:.8;}
        .course-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;}
        .course-card{background:#fff;border-radius:12px;padding:1.5rem;border:2px solid #b6ccd7;transition:all 0.3s;}
        .course-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px #0f439233;border-color:#6393d1;}
        .course-time{font-size:1.25rem;font-weight:700;color:#112947;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;}
        .participant-count{display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;font-size:1rem;color:#112947;}
        .count-number{font-size:1.5rem;font-weight:700;color:#0f4392;}
        .status-badge{display:inline-block;padding:0.5rem 1rem;border-radius:20px;font-size:0.875rem;font-weight:600;margin-bottom:1rem;}
        .status-confirmed{background:#6393d1;color:#fff;}
        .status-pending{background:#b6ccd7;color:#112947;}
        .register-btn{width:100%;padding:0.75rem;background:linear-gradient(135deg,#eeba2b 0%,#f8e185 100%);color:#112947;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;}

        /* Modal æ¨£å¼ */
        .modal-backdrop { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); 
            display: none; justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content { 
            background: white; padding: 2rem; border-radius: 16px; 
            width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9); opacity: 0; transition: all 0.3s ease-out;
        }
        .modal-content.show {
            transform: scale(1); opacity: 1;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="container">

        <!-- Header and Banner -->
        <header class="header text-center">
            <div class="header-content">
                <!-- åœ–ç‰‡è·¯å¾‘å¿…é ˆæ˜¯ /for_logo.png -->
                <img 
                    src="/for_logo.png" 
                    alt="æœªä¾†å°èˆªå•†å“ç…§" 
                    class="logo-image"
                >
                <div class="title-section">
                    <h1 class="text-white">äººé¡åœ–æ¡ŒéŠã€Œæœªä¾†å°èˆªã€</h1>
                    <p class="subtitle text-amber-300">æªåœ˜ç¥å™¨</p>
                </div>
            </div>
            
            <p class="description text-white">
                å…¨çƒé¦–æ¬¾çµåˆäººé¡åœ–åŸç†çš„äº’å‹•æ¡ŒéŠï¼Œã€Šæœªä¾†å°èˆªã€‹è®“ä½ é€ééŠæˆ²è‡ªç„¶ç†è§£äººé¡åœ–ã€å­¸æœƒé¸æ“‡ã€ç·´ç¿’æ±ºç­–æµç¨‹ã€‚é‚€ä½ ä¸€èµ·æ¿€ç›ªé«”é©—ï¼
            </p>
            <p id="last-updated" class="updatetime">è¼‰å…¥ä¸­...</p>
        </header>

        <!-- å…§å®¹å€å¡Š -->
        <div class="content">

            <!-- æªåœ˜æµç¨‹èªªæ˜ -->
            <section class="process-section">
                <h2 class="process-title">æªåœ˜æµç¨‹èªªæ˜</h2>
                <div class="process-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>é»æ“Šæªåœ˜</h3>
                            <p>é¸æ“‡æ™‚æ®µä¸¦é€²å…¥ Email ç™»è¨˜</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>æªåœ˜äººæ•¸è¿½è¹¤</h3>
                            <p>ç³»çµ±å³æ™‚æ›´æ–°ç‹€æ…‹ï¼Œé”æ¨™è‡ªå‹•æˆåœ˜</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>æ­£å¼å ±åç¹³è²»</h3>
                            <p>æˆåœ˜å¾Œï¼Œæ‚¨å°‡æ”¶åˆ° Email é€šçŸ¥é€²è¡Œå ±åä»˜æ¬¾ã€‚</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ™‚æ®µåˆ—è¡¨å€å¡Š -->
            <section>
                <h2 class="process-title text-left border-b pb-2 mb-4">ç›®å‰å¯å ±åæ™‚æ®µ</h2>
                <div id="course-list" class="course-grid">
                    <!-- Course cards will be injected here by JavaScript -->
                    <div class="text-center p-10 text-gray-500" id="loading-message">
                        <!-- Tailwind class for spinner is disabled, using simple text -->
                        æ­£åœ¨è¼‰å…¥æœ€æ–°çš„æªåœ˜äººæ•¸...
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- å ±åå½ˆçª— Modal (Hidden by default) -->
    <div id="modal-backdrop" class="modal-backdrop">
        <div id="modal-content" class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">åƒåŠ æªåœ˜: </h3>
            <p class="text-sm text-gray-600 mb-4">è«‹å¡«å¯« Email (æˆåœ˜é€šçŸ¥å°‡å¯„è‡³æ­¤ä¿¡ç®±)ã€‚</p>
            
            <form id="registration-form" class="space-y-4">
                <div>
                    <label for="displayName" class="block text-sm font-medium text-gray-700">æ‚¨çš„æš±ç¨±/å§“å</label>
                    <input type="text" id="displayName" name="displayName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="ä¾‹å¦‚ï¼šäººé¡åœ–æ„›å¥½è€…">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email (å ±åä¿¡ç®±)</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="your@email.com">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="modal-cancel-btn" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 text-white bg-amber-500 rounded-lg hover:bg-amber-600 transition duration-150 font-semibold">ç¢ºèªç™»è¨˜</button>
                </div>
            </form>

            <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-xl hidden">
                <p class="ml-3 text-gray-700">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
            </div>
            <div id="status-message" class="mt-4 text-center hidden"></div>
        </div>
    </div>
    
    <script>
        // èª²ç¨‹è³‡æ–™ï¼ŒID å¿…é ˆæ˜¯æ•¸å­—å­—ä¸² '1', '2', '3'
        const coursesData = [
            { 
                id: '1', 
                date: '11/10 (æ—¥) | 14:00â€“17:00', 
                location: 'å°åŒ— | å¹³æ—¥ä¸‹åˆå ´', 
                minAttendees: 3, 
                target: 'https://webhook.n8n.cloud/webhook-test/group-register' // è«‹æ›¿æ›æˆæ‚¨çš„ n8n Webhook URL
            },
            { 
                id: '2', 
                date: '11/12 (äºŒ) | 19:00â€“22:00', 
                location: 'å°åŒ— | å¹³æ—¥æ™šä¸Šå ´', 
                minAttendees: 5, 
                target: 'https://webhook.n8n.cloud/webhook-test/group-register' // è«‹æ›¿æ›æˆæ‚¨çš„ n8n Webhook URL
            },
            { 
                id: '3', 
                date: '11/15 (äº”) | 14:00â€“17:00', 
                location: 'å°ä¸­ | å‡æ—¥å ´', 
                minAttendees: 6, 
                target: 'https://webhook.n8n.cloud/webhook-test/group-register' // è«‹æ›¿æ›æˆæ‚¨çš„ n8n Webhook URL
            }
        ];

        // API å‘¼å«çš„è¨­å®š
        const API_BASE_URL = window.location.origin; // å–å¾—ç•¶å‰ Vercel ç¶²å€

        let selectedCourseId = null;
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const registrationForm = document.getElementById('registration-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const statusMessage = document.getElementById('status-message');
        const courseListContainer = document.getElementById('course-list');
        const loadingMessage = document.getElementById('loading-message');


        // --- Helper Functions for UI and State ---

        function showModal(course) {
            selectedCourseId = course.id;
            modalTitle.textContent = `åƒåŠ æªåœ˜: ${course.date} (${course.location})`;
            
            // é‡ç½®è¡¨å–®å’Œç‹€æ…‹è¨Šæ¯
            registrationForm.reset();
            statusMessage.classList.add('hidden');
            statusMessage.innerHTML = '';
            registrationForm.classList.remove('hidden'); // ç¢ºä¿è¡¨å–®é¡¯ç¤º
            
            modalBackdrop.style.display = 'flex';
            
            // å•Ÿç”¨éæ¸¡å‹•ç•«
            setTimeout(() => {
                modalContent.classList.add('show');
            }, 10); 
        }

        function hideModal() {
            // ç¦ç”¨éæ¸¡å‹•ç•«
            modalContent.classList.remove('show');
            
            setTimeout(() => {
                modalBackdrop.style.display = 'none';
            }, 300); // ç­‰å¾…å‹•ç•«å®Œæˆ
        }

        // --- Core Logic: Fetch and Display ---

        async function fetchAttendeeCounts() {
            try {
                // å‘¼å« Vercel Serverless Function
                const response = await fetch(`${API_BASE_URL}/api/count.js`); 
                if (!response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                }
                const counts = await response.json();
                
                loadingMessage.classList.add('hidden');
                renderCourseList(counts);
                updateLastUpdatedTime();

            } catch (error) {
                console.error("è¼‰å…¥äººæ•¸è¨ˆæ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                loadingMessage.textContent = `è¼‰å…¥äººæ•¸å¤±æ•—ï¼š${error.message}ã€‚è«‹ç¨å¾Œé‡è©¦ã€‚`;
                loadingMessage.classList.remove('hidden');
                loadingMessage.classList.add('text-red-500');
            }
        }

        function renderCourseList(counts) {
            courseListContainer.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            
            coursesData.forEach(course => {
                const countData = counts.find(c => String(c.id) === course.id);
                const currentAttendees = countData ? countData.attendees : 0;
                const isGroupFormed = currentAttendees >= course.minAttendees;
                const attendeesRemaining = Math.max(0, course.minAttendees - currentAttendees);
                
                const statusBadgeClass = isGroupFormed ? 'status-confirmed' : 'status-pending';
                const statusText = isGroupFormed ? 'å·²æˆåœ˜ (å·²å¯å ±åç¹³è²»)' : 'æªåœ˜ä¸­';
                const buttonText = isGroupFormed ? 'å‰å¾€æ­£å¼å ±å' : 'æˆ‘è¦åƒåŠ æªåœ˜';
                const buttonColorClass = isGroupFormed ? 'bg-blue-500 hover:bg-blue-600' : 'bg-amber-500 hover:bg-amber-600';

                const cardHtml = `
                    <div class="course-card ${isGroupFormed ? 'border-2 border-green-500' : ''}">
                        <!-- ç‹€æ…‹æ¨™ç±¤ -->
                        <div class="status-badge ${statusBadgeClass}">${statusText}</div>

                        <!-- Header / Date -->
                        <div class="course-time">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            ${course.date}
                        </div>
                        <p class="text-gray-500 text-sm mb-3">${course.location}</p>

                        <!-- äººæ•¸è³‡è¨Š -->
                        <div class="participant-count">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                            ç›®å‰æªåœ˜: <span class="count-number">${currentAttendees} äºº</span> 
                            <span class="text-sm text-gray-500 ml-2"> (æœ€ä½ ${course.minAttendees} äºº)</span>
                        </div>
                        
                        <!-- å·®å¹¾äººè¨Šæ¯ -->
                        <div class="text-sm font-medium ${isGroupFormed ? 'text-green-600' : 'text-amber-600'} mb-4">
                            ${isGroupFormed ? 'ğŸ‰ æ­å–œå·²é”æ¨™ï¼' : `é‚„å·® ${attendeesRemaining} äººæˆåœ˜`}
                        </div>

                        <!-- å ±åæŒ‰éˆ• -->
                        <button 
                            data-course-id="${course.id}" 
                            class="register-btn transition duration-200"
                        >
                            ${buttonText}
                        </button>
                    </div>
                `;
                courseListContainer.innerHTML += cardHtml;
            });

            // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.register-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.courseId;
                    const course = coursesData.find(c => c.id === id);
                    if (course) {
                        showModal(course);
                    }
                });
            });
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const formattedTime = now.toLocaleTimeString('zh-Hant', {hour: '2-digit', minute:'2-digit'});
            const formattedDate = now.toLocaleDateString('zh-Hant', {month: 'numeric', day: 'numeric'});
            document.getElementById('last-updated').textContent = `æœ€å¾Œæ›´æ–°: ${formattedDate} ${formattedTime}`;
        }


        // --- Event Listeners and Initial Load ---

        // å½ˆçª—å–æ¶ˆæŒ‰éˆ•
        modalCancelBtn.addEventListener('click', hideModal);

        // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                hideModal();
            }
        });

        // å ±åè¡¨å–®æäº¤äº‹ä»¶
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const displayName = document.getElementById('displayName').value;
            const email = document.getElementById('email').value;
            const courseId = selectedCourseId;
            const course = coursesData.find(c => c.id === courseId);
            
            if (!course) {
                alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é¸å®šçš„èª²ç¨‹æ™‚æ®µã€‚'); // é€™è£¡ä½¿ç”¨ alert åªæ˜¯ç‚ºäº†å¿«é€Ÿé™¤éŒ¯
                return;
            }

            loadingOverlay.classList.remove('hidden');
            statusMessage.classList.add('hidden');
            registrationForm.classList.add('opacity-50', 'pointer-events-none'); // ç¦ç”¨è¡¨å–®

            try {
                // æäº¤è³‡æ–™åˆ° n8n Webhook
                const webhookUrl = course.target;
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        displayName: displayName,
                        email: email,
                        courseId: courseId, // å‚³éæ•¸å­—å­—ä¸² ID
                        timeSlot: course.date + ' ' + course.location
                    })
                });

                // n8n Webhook é æœŸè¿”å› 200 OK
                if (response.ok) {
                    statusMessage.className = 'mt-4 text-center p-3 bg-green-100 text-green-700 rounded-lg';
                    statusMessage.textContent = 'âœ… ç™»è¨˜æˆåŠŸï¼è«‹æ³¨æ„æŸ¥æ”¶æ‚¨çš„ Email ä¿¡ç®±ï¼Œå¾ŒçºŒå°‡ä»¥ Email é€šçŸ¥æˆåœ˜èˆ‡å¦ã€‚';
                    registrationForm.classList.add('hidden');
                } else {
                    const errorText = await response.text();
                    throw new Error(`ç™»è¨˜å¤±æ•—ï¼Œä¼ºæœå™¨å›æ‡‰: ${response.status} - ${errorText.substring(0, 100)}`);
                }

            } catch (error) {
                console.error("å ±åæäº¤éŒ¯èª¤:", error);
                statusMessage.className = 'mt-4 text-center p-3 bg-red-100 text-red-700 rounded-lg';
                statusMessage.textContent = `âŒ ç™»è¨˜å¤±æ•—ï¼š${error.message}ã€‚è«‹è¯ç¹«ç®¡ç†å“¡ã€‚`;
                registrationForm.classList.remove('hidden');
                registrationForm.classList.remove('opacity-50', 'pointer-events-none'); // é‡æ–°å•Ÿç”¨è¡¨å–®

            } finally {
                loadingOverlay.classList.add('hidden');
                statusMessage.classList.remove('hidden');
                // é‡æ–°è¼‰å…¥äººæ•¸ï¼Œå³æ™‚æ›´æ–°ç•«é¢
                fetchAttendeeCounts();
            }
        });


        // é é¢è¼‰å…¥å®Œæˆå¾Œï¼Œå•Ÿå‹•å®šæ™‚æ›´æ–°
        window.onload = function() {
            // ç«‹å³è¼‰å…¥äººæ•¸
            fetchAttendeeCounts(); 
            // ä¹‹å¾Œæ¯ 60 ç§’æ›´æ–°ä¸€æ¬¡äººæ•¸ï¼Œä¿æŒé é¢è³‡è¨Šæœ€æ–°
            setInterval(fetchAttendeeCounts, 60000); 
        };

    </script>
</body>
</html>
