<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººé¡åœ–æ¡ŒéŠã€Œæœªä¾†å°èˆªã€æªåœ˜ç¥å™¨</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            background: linear-gradient(135deg, #0f4392 0%, #6393d1 100%);
            margin: 0; padding: 0;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; 
        }
        .container { 
            max-width:900px; width:100%; margin:2rem auto;
            background:#fff; border-radius:20px; box-shadow:0 20px 60px #0004; overflow:hidden;
        }
        .header { background: linear-gradient(135deg,#0f4392 0%,#6393d1 100%);
            color:#fff;padding:2.5rem 2rem;}
        .header-content{ display:flex; align-items:center; justify-content:center; gap:2.5rem; margin-bottom:1.5rem;}
        .logo-image { width:120px; height:120px; object-fit:cover; border-radius:14px; box-shadow:0 2px 8px #0f43924d; }
        .title-section h1 { margin:0;font-size:2rem;font-weight:700;text-align:left;}
        .title-section h2 { margin: 0; font-size: 2rem; font-weight: 700; text-align: left; color: #f8e185; line-height: 1.2;}
        .description { margin:0 0 1rem 0; font-size:1rem; opacity:.95; max-width:600px; margin-left:auto; margin-right:auto;
            line-height:1.6; background:rgba(255,255,255,0.1); padding:1rem 1.5rem; border-radius:12px;}
        .updatetime{margin-top:1.2em;font-size:.98em;color:#fff;opacity:.94;font-weight:600; text-align: center;}
        .content {padding:2rem;}
        .process-section{background:#fff;border-radius:16px;padding:2rem;margin-bottom:2rem;border:2px solid #eeba2b;box-shadow:0 4px 20px #eeba2b26;}
        .process-title{color:#112947;font-size:1.5rem;font-weight:700;text-align:center;margin:0 0 1.5rem 0;}
        .process-steps{display:flex;justify-content:space-between;align-items:stretch;gap:1rem;}
        .step{flex:1;display:flex;flex-direction:column;align-items:center;text-align:center;background:#f8e185;padding:1.5rem 1rem;border-radius:12px;border:1px solid #eeba2b;}
        .step-number{background:#0f4392;color:#fff;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;margin-bottom:1rem;}
        .step-content h3{color:#112947;font-size:1.1rem;font-weight:600;margin:0 0 0.75rem 0;}
        .step-content p{color:#112947;font-size:0.9rem;line-height:1.4;margin:0;opacity:.8;}
        .course-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;}
        .course-card{background:#fff;border-radius:12px;padding:1.5rem;border:2px solid #b6ccd7;transition:all 0.3s;}
        .course-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px #0f439233;border-color:#6393d1;}
        .course-time{font-size:1.25rem;font-weight:700;color:#112947;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;}
        .participant-count{display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;font-size:1rem;color:#112947;}
        .count-number{font-size:1.5rem;font-weight:700;color:#0f4392;}
        .status-badge{display:inline-block;padding:0.5rem 1rem;border-radius:20px;font-size:0.875rem;font-weight:600;margin-bottom:1rem;}
        .status-confirmed{background:#6393d1;color:#fff;}
        .status-pending{background:#b6ccd7;color:#112947;}
        .register-btn{width:100%;padding:0.75rem;background:linear-gradient(135deg,#eeba2b 0%,#f8e185 100%);color:#112947;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;}
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 9999;}
        .modal-content { background: white; padding: 2rem; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9); opacity: 0; transition: all 0.3s ease-out;}
        .modal-content.show { transform: scale(1); opacity: 1;}
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container">

        <header class="header text-center">
            <div class="header-content">
                <img src="/for_logo.png" alt="æœªä¾†å°èˆªå•†å“ç…§" class="logo-image">
                <div class="title-section">
                    <h1 class="text-white">äººé¡åœ–æ¡ŒéŠã€Œæœªä¾†å°èˆªã€</h1>
                    <h2 class="text-amber-300">æªåœ˜ç¥å™¨</h2>
                </div>
            </div>
            <p class="description text-white">
                å…¨çƒé¦–æ¬¾çµåˆäººé¡åœ–åŸç†çš„äº’å‹•æ¡ŒéŠï¼Œã€Šæœªä¾†å°èˆªã€‹è®“ä½ é€ééŠæˆ²è‡ªç„¶ç†è§£äººé¡åœ–ã€å­¸æœƒé¸æ“‡ã€ç·´ç¿’æ±ºç­–æµç¨‹ã€‚é‚€ä½ ä¸€èµ·æ¿€ç›ªé«”é©—ï¼
            </p>
            <p id="last-updated" class="updatetime">è¼‰å…¥ä¸­...</p>
        </header>

        <div class="content">
            <section class="process-section">
                <h2 class="process-title">æªåœ˜æµç¨‹èªªæ˜</h2>
                <div class="process-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>é»æ“Šæªåœ˜</h3><p>é¸æ“‡æ™‚æ®µä¸¦é€²å…¥ Email ç™»è¨˜</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>æªåœ˜äººæ•¸è¿½è¹¤</h3><p>ç³»çµ±å³æ™‚æ›´æ–°ç‹€æ…‹ï¼Œé”æ¨™è‡ªå‹•æˆåœ˜</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>æ­£å¼å ±åç¹³è²»</h3><p>æˆåœ˜å¾Œï¼Œæ‚¨å°‡æ”¶åˆ° Email é€šçŸ¥é€²è¡Œå ±åä»˜æ¬¾ã€‚</p>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="process-title text-left border-b pb-2 mb-4">ç›®å‰å¯å ±åæ™‚æ®µ</h2>
                <div id="course-list" class="course-grid">
                    <div class="text-center p-10 text-gray-500" id="loading-message">æ­£åœ¨è¼‰å…¥æœ€æ–°çš„æªåœ˜äººæ•¸...</div>
                </div>
            </section>
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop">
        <div id="modal-content" class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">åƒåŠ æªåœ˜: </h3>
            <p class="text-sm text-gray-600 mb-4">è«‹å¡«å¯« Email (æˆåœ˜é€šçŸ¥å°‡å¯„è‡³æ­¤ä¿¡ç®±)ã€‚</p>
            
            <form id="registration-form" class="space-y-4">
                <div>
                    <label for="displayName" class="block text-sm font-medium text-gray-700">æ‚¨çš„æš±ç¨±/å§“å</label>
                    <input type="text" id="displayName" name="displayName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="ä¾‹å¦‚ï¼šäººé¡åœ–æ„›å¥½è€…">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email (å ±åä¿¡ç®±)</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="your@email.com">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="modal-cancel-btn" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 text-white bg-amber-500 rounded-lg hover:bg-amber-600 transition duration-150 font-semibold">ç¢ºèªç™»è¨˜</button>
                </div>
            </form>
            <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-xl hidden"><p class="ml-3 text-gray-700">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p></div>
            <div id="status-message" class="mt-4 text-center hidden"></div>
        </div>
    </div>

    <script>
      const coursesData = [
        { id: '1', date: '11/10 (æ—¥) | 14:00â€“17:00', location: 'å°åŒ— | å¹³æ—¥ä¸‹åˆå ´', minAttendees: 3, target: 'https://repeat-taxi.app.n8n.cloud/webhook/group-register' },
        { id: '2', date: '11/12 (äºŒ) | 19:00â€“22:00', location: 'å°åŒ— | å¹³æ—¥æ™šä¸Šå ´', minAttendees: 3, target: 'https://repeat-taxi.app.n8n.cloud/webhook/group-register' },
        { id: '3', date: '11/15 (äº”) | 14:00â€“17:00', location: 'å°ä¸­ | å‡æ—¥å ´', minAttendees: 3, target: 'https://repeat-taxi.app.n8n.cloud/webhook/group-register' }
      ];

      const API_BASE_URL = window.location.origin;
      let selectedCourseId = null;
      const modalBackdrop = document.getElementById('modal-backdrop');
      const modalContent = document.getElementById('modal-content');
      const modalTitle = document.getElementById('modal-title');
      const modalCancelBtn = document.getElementById('modal-cancel-btn');
      const registrationForm = document.getElementById('registration-form');
      const loadingOverlay = document.getElementById('loading-overlay');
      const statusMessage = document.getElementById('status-message');
      const courseListContainer = document.getElementById('course-list');
      const loadingMessage = document.getElementById('loading-message');

      function showModal(course){selectedCourseId=course.id;modalTitle.textContent=`åƒåŠ æªåœ˜: ${course.date} (${course.location})`;registrationForm.reset();statusMessage.classList.add('hidden');registrationForm.classList.remove('hidden');modalBackdrop.style.display='flex';setTimeout(()=>modalContent.classList.add('show'),10);}
      function hideModal(){modalContent.classList.remove('show');setTimeout(()=>modalBackdrop.style.display='none',300);}
      async function fetchAttendeeCounts(){try{const r=await fetch(`${API_BASE_URL}/api/count`);if(!r.ok)throw new Error(`API ${r.status}`);const d=await r.json();loadingMessage.classList.add('hidden');renderCourseList(d);updateLastUpdatedTime();}catch(e){loadingMessage.textContent=`ğŸš¨ ç„¡æ³•è¼‰å…¥äººæ•¸ï¼š${e.message}`;loadingMessage.classList.remove('hidden');}}
      function renderCourseList(counts){
        courseListContainer.innerHTML='';
        coursesData.forEach(c=>{
          const data=counts.find(x=>String(x.id)===c.id);
          const n=data?data.attendees:0;
          const formed=n>=c.minAttendees;
          const full=n>=6;
          const remain=Math.max(0,c.minAttendees-n);
          const statusText=formed?'å·²æˆåœ˜':'æªåœ˜ä¸­';
          const reachText=full?'ğŸ‰ å·²æ»¿ä¸€æ¡Œï¼Œç¬¬äºŒæ¡Œç¹¼çºŒå‹Ÿé›†ä¸­ï¼':formed?'æˆ‘å€‘æˆåœ˜å•¦ï¼å¿«ä¾†åŠ å…¥ï¼':`é‚„å·® ${remain} äººæˆåœ˜`;
          const buttonText=formed?'å‰å¾€æ­£å¼å ±å':'æˆ‘è¦åƒåŠ æªåœ˜';
          const card=`<div class="course-card ${formed?'border-2 border-green-500':''}">
            <div class="status-badge ${formed?'status-confirmed':'status-pending'}">${statusText}</div>
            <div class="course-time"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${c.date}</div>
            <p class="text-gray-500 text-sm mb-3">${c.location}</p>
            <div class="participant-count"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>ç›®å‰æªåœ˜: <span class="count-number">${n} äºº</span><span class="text-sm text-gray-500 ml-2">(æœ€ä½ ${c.minAttendees} äºº)</span></div>
            <div class="text-sm font-medium ${formed?'text-green-600':'text-amber-600'} mb-4">${reachText}</div>
            <button data-id="${c.id}" class="register-btn ${formed?'bg-blue-500 hover:bg-blue-600':'bg-amber-500 hover:bg-amber-600'}">${buttonText}</button></div>`;
          courseListContainer.innerHTML+=card;
        });
        document.querySelectorAll('.register-btn').forEach(b=>{
          b.addEventListener('click',e=>{
            const id=e.currentTarget.dataset.id;const c=coursesData.find(x=>x.id===id);
            if(!c)return;
            if(b.textContent.includes('æ­£å¼')){const tally='https://tally.so/r/xxxxx';window.open(`${tally}?courseId=${c.id}&courseTitle=${encodeURIComponent(c.date)}`,'_blank');}
            else showModal(c);
          });
        });
      }
      function updateLastUpdatedTime(){const n=new Date();document.getElementById('last-updated').textContent=`æœ€å¾Œæ›´æ–°ï¼š${n.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric'})} ${n.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})}`;}
      modalCancelBtn.addEventListener('click',hideModal);
      modalBackdrop.addEventListener('click',e=>{if(e.target===modalBackdrop)hideModal();});
      registrationForm.addEventListener('submit',async e=>{
        e.preventDefault();
        const name=document.getElementById('displayName').value,email=document.getElementById('email').value,c=coursesData.find(x=>x.id===selectedCourseId);
        if(!c)return;
        loadingOverlay.classList.remove('hidden');
        try{
          const r=await fetch(c.target,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({displayName:name,email,courseId:c.id,timeSlot:`${c.date} ${c.location}`})});
          if(!r.ok)throw new Error(`Webhook éŒ¯èª¤ ${r.status}`);
          statusMessage.className='mt-4 text-center p-3 bg-green-100 text-green-700 rounded-lg';
          statusMessage.innerHTML='âœ… ç™»è¨˜æˆåŠŸï¼<br>è«‹è¨˜å¾—ç¶å®š LINE å®˜æ–¹å¸³è™Ÿæ¥æ”¶å³æ™‚é€šçŸ¥ï¼Œ<br>æˆ–è¼¸å…¥é—œéµå­—ã€Œæ¡ŒéŠæªåœ˜ã€æŸ¥çœ‹æœ€æ–°äººæ•¸ã€‚';
          registrationForm.classList.add('hidden');
        }catch(err){statusMessage.className='mt-4 text-center p-3 bg-red-100 text-red-700 rounded-lg';statusMessage.textContent=`âŒ ç™»è¨˜å¤±æ•—ï¼š${err.message}`;}
        finally{loadingOverlay.classList.add('hidden');statusMessage.classList.remove('hidden');fetchAttendeeCounts();}
      });
      window.onload=()=>{fetchAttendeeCounts();setInterval(fetchAttendeeCounts,60000);}
    </script>
</body>
</html>
